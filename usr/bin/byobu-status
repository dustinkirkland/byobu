#!/bin/bash -e
#
#    byobu-status
#    Copyright (C) 2008 Canonical Ltd.
#
#    Authors: Dustin Kirkland <kirkland@canonical.com>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, version 3 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

PKG="byobu"
DATA="$HOME/.$PKG"
[ -z "$BYOBU_PREFIX" ] && export BYOBU_PREFIX="/usr" || export BYOBU_PREFIX

find_script () {
	# Allow for local status scripts
	if [ -x "$DATA/bin/$1" ]; then
		_RET="$DATA/bin/$1"
	elif [ -x "$BYOBU_PREFIX/lib/$PKG/$1" ]; then
		_RET="$BYOBU_PREFIX/lib/$PKG/$1"
	elif [ -x "$BYOBU_PREFIX/libexec/$PKG/$1" ]; then
		_RET="$BYOBU_PREFIX/libexec/$PKG/$1"
	else
		_RET="/dev/null"
	fi
}

# Define colors
ESC="\005"
color() {
	case "$1" in
		"") return 0 ;;
		-)   printf "$ESC{-}" ;;
		esc)    printf "$ESC" ;;
		bold1)  printf "$ESC{=b }" ;;
		bold2)  printf "$ESC{+b }" ;;
		none)   printf "$ESC{= }" ;;
		invert) printf "$ESC{=r }" ;;
		*)
			if [ "$#" = "2" ]; then
				[ "$MONOCHROME" = "1" ] && printf "$ESC{= }"   || printf "$ESC{= $1$2}"
			else
				[ "$MONOCHROME" = "1" ] && printf "$ESC{=$1 }" || printf "$ESC{=$1 $2$3}"
			fi
		;;
	esac
}

# Source configurations
[ -r "$DATA/color" ] && . "$DATA/color"
[ -r "/etc/$PKG/statusrc" ] && . "/etc/$PKG/statusrc"
[ -r "$DATA/status" ] && . "$DATA/status"
[ -r "$DATA/statusrc" ] && . "$DATA/statusrc"

export P="$1"
case "$P" in
	--detail)
		VER=
		if command -v dpkg-query >/dev/null; then
			VER=$(set -- $(dpkg-query --show $PKG); echo "$2")
		fi
		printf "$PKG-$VER Detailed Status Navigation\n"
		if command -v vim >/dev/null && `vim --version | grep -q +folding`; then
			printf "  Expand all - zr\t\tCollapse all - zm\n  Expand one - zo\t\tCollapse one - zc\n\n"
		fi
		for i in "$BYOBU_PREFIX/lib/$PKG"/* "$DATA/bin"/*; do
			i=${i##*/}
			[ "$i" = "menu" ] && continue

			find_script "$i" && script="${_RET}"
			short=`$script --short | sed -e 's/^\s*//' -e 's/\s*$//' -e 's/.{[^}]*}//g'` || true
			detail=`$script --detail 2>/dev/null | sed -e '/^$/d' -e 's/^/\t/g'` || true
			printf "%s\n\t(%s)\n" "$short" "$i"
			[ -n "$detail" ] && printf "%s\n" "$detail"
		done
	;;
	color)
		[ -z "$FOREGROUND" ] && FOREGROUND="w"
		[ -z "$BACKGROUND" ] && BACKGROUND="k"
		printf "$ESC{= $BACKGROUND$FOREGROUND}"
	;;
	*)
		[ -f "$HOME/.$PKG/status.disable" ] && exit 0
		eval x="\$$P" || exit 1
		[ "$x" = "1" ] || exit 0
		shift
		find_script "$P" && . "${_RET}" "$@"
	;;
esac
